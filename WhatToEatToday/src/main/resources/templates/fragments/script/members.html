<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <th:block th:fragment="script">
    <script
      type="text/javascript"
      src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=wbeu0mozwg&submodules=panorama"
    ></script>
    <script th:inline="javascript">
      const members = [[${members}]];

      const membersBody = document.querySelector(".members_body");
      const tr = membersBody.querySelectorAll("tr");
      for( let i=0; i<members.length; i++) {
          if(members[i].address !== null) {

            const address = JSON.parse(members[i].address).addresses[0];
            const addressTd = tr[i].querySelector("td:nth-child(8)");

            addressTd.innerText = "";

            const mapActiveButtonLabel = document.createElement("label");

            mapActiveButtonLabel.setAttribute("for", "map_active_button" + i);

            const addressSpan = document.createElement("span");

            addressSpan.innerText = address.roadAddress;
            mapActiveButtonLabel.appendChild(addressSpan);
            addressTd.appendChild(mapActiveButtonLabel);

            const mapActiveButton = document.createElement("input");

            mapActiveButton.type = "radio" ;
            mapActiveButton.name = "map_active_button";
            mapActiveButton.className = "map_active_button";

            mapActiveButton.id = "map_active_button" + i;

            addressTd.appendChild( mapActiveButton);


            const mapCloseButtonLabel = document.createElement("label");

            mapCloseButtonLabel.setAttribute("for", "map_close_button");

            const mapOuter = document.createElement("figure");

            mapOuter.className = "map_outer";

            const mapInner = document.createElement("div");

            mapInner.className = "map_inner";

            mapOuter.appendChild(mapInner);

            const mapFigureCaption = document.createElement("figcaption");

            mapFigureCaption.innerText = `${address.roadAddress} ${members[i].addressDetail}`;

            mapOuter.appendChild(mapFigureCaption);

            mapOuter.addEventListener("click", (e) => e.preventDefault());

            mapCloseButtonLabel.appendChild(mapOuter);

            addressTd.appendChild(mapCloseButtonLabel);

            const HOME_PATH = "http://" + window.location.host || '.';

            const Lat = Number(address.y)
            const Lng = Number(address.x)
            const map = new naver.maps.Map(mapInner, {
              center: new naver.maps.LatLng(Lat, Lng),
              zoom: 13,
              minZoom: 6,
              zoomControl: true,
              zoomControlOptions: {
                  position: naver.maps.Position.TOP_RIGHT
              },
              mapDataControl: false,
              logoControlOptions: {
                  position: naver.maps.Position.LEFT_BOTTOM
              },
              disableKineticPan: false
            });

            const urlMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(Lat, Lng),
                map: map,
                title: 'urlMarker',
                icon: {
                  url: HOME_PATH +"/img/map/pin_User.png",
                  size: new naver.maps.Size(44, 65),
                  scaledSize: new naver.maps.Size(44, 65),
                  origin: new naver.maps.Point(0, 0),
                  anchor: new naver.maps.Point(12, 34)
                },
                animation: naver.maps.Animation.BOUNCE
            });

            naver.maps.Event.addListener(urlMarker, 'click', function() {
                if (urlMarker.getAnimation() !== null) {
                    urlMarker.setAnimation(null);
                } else {
                    urlMarker.setAnimation(naver.maps.Animation.BOUNCE);
                }
            });

            naver.maps.Event.addListener(urlMarker, 'click', function() {
                if (urlMarker.getAnimation() !== null) {
                    urlMarker.setAnimation(null);
                } else {
                    urlMarker.setAnimation(naver.maps.Animation.BOUNCE);
                }
            });
          }
      }

      function setDownloadMembersCsv() {
        const csv = []
        const tempMembers = members;
        let columns = Object.keys(tempMembers[0])

        for(let i=1; i<tempMembers.length; i++){
          columns = columns.filter(column => Object.keys(tempMembers[i]).includes(column));
        }

        csv.push(columns.join(","));

        for(let member of tempMembers){
          const data = []
          for(let column of columns){
            if(column === "address"){
              if(member[column] !== null){
                console.log(JSON.parse(member[column]))
                data.push(JSON.parse(member[column]).addresses[0].roadAddress);
              }else {
                data.push("");
              }
            }else {
              data.push(member[column]);
            }
          }
          csv.push(data.join(","))
        }

        downloadCSV(csv.join("\n"), "멤버 정보");
      }
      function downloadCSV(csv, filename) {
        var csvFile;
        var downloadLink;

        //한글 처리를 해주기 위해 BOM 추가하기
        const BOM = "\uFEFF";
        csv = BOM + csv;

        csvFile = new Blob([csv], { type: "text/csv" });

        downloadLink = document.createElement("a");
        downloadLink.className = "download_button"
        downloadLink.innerText = filename + " 다운받기"
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        document.querySelector(".main .inner").prepend(downloadLink);
      }
      setDownloadMembersCsv();
    </script>
  </th:block>
</html>
